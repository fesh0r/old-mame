#include "driver.h"
#include "common.h"

INLINE UINT8 NIBBLE(UINT32 n, UINT8 a, UINT8 b, UINT8 c, UINT8 d)
{
	UINT32 a1 = (n >> a) & 0x1;
	UINT32 b1 = (n >> b) & 0x1;
	UINT32 c1 = (n >> c) & 0x1;
	UINT32 d1 = (n >> d) & 0x1;
	return ((a1 << 3) | (b1 << 2) | (c1 << 1) | d1);
}

static unsigned char crypt_table1[][16] =
{
	//  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   A,   B,   C,   D,   E,   F
	{ 0x2, 0xe, 0x6, 0x9, 0x3, 0xf, 0x7, 0x8, 0x1, 0xd, 0x5, 0xb, 0x0, 0xc, 0x4, 0xa }
};

static unsigned char crypt_table2[][16] =
{
	//  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   A,   B,   C,   D,   E,   F
	{ 0x1, 0x0, 0x9, 0x0, 0xf, 0xa, 0x7, 0x6, 0x3, 0x8, 0xb, 0x2, 0xc, 0x5, 0x4, 0xd },
};

/*static unsigned char crypt_table3[][16] =
{
	//  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   A,   B,   C,   D,   E,   F
	{ 0xa, 0xe, 0x2, 0x6, 0xb, 0xf, 0x3, 0x7, 0x8, 0xc, 0x0, 0x4, 0x9, 0xd, 0x1, 0x5 },
	{ 0xc, 0x8, 0x4, 0x0, 0xd, 0x9, 0x5, 0x1, 0xf, 0xb, 0x7, 0x3, 0x6, 0x2, 0xe, 0xa },
};*/
static unsigned char crypt_table3[][16] =
{
	//  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   A,   B,   C,   D,   E,   F
	{ 0x2, 0xe, 0xa, 0x6, 0x3, 0xf, 0xb, 0x7, 0x0, 0xc, 0x8, 0x4, 0x1, 0xd, 0x9, 0x5 },
	{ 0xc, 0x0, 0x4, 0x8, 0xd, 0x1, 0x5, 0x9, 0xf, 0x3, 0x7, 0xb, 0xe, 0x2, 0x6, 0xa },
};

static unsigned char crypt_table4[][16] =
{
	//  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   A,   B,   C,   D,   E,   F
	{ 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf },
	{ 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0 },
	{ 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8 },
	{ 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4 },

	{ 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc },
	{ 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2 },
	{ 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa },
	{ 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6 },

	{ 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe },
	{ 0x9, 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1 },
	{ 0x5, 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9 },
	{ 0xd, 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5 },

	{ 0x3, 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd },
	{ 0xb, 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3 },
	{ 0x7, 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb },
	{ 0xf, 0x0, 0x8, 0x4, 0xc, 0x2, 0xa, 0x6, 0xe, 0x1, 0x9, 0x5, 0xd, 0x3, 0xb, 0x7 },
};

static unsigned char crypt_table5[][16] =
{
	//  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   A,   B,   C,   D,   E,   F
	{ 0x9, 0x1, 0xd, 0x5, 0xa, 0x2, 0xe, 0x6, 0x8, 0x0, 0xc, 0x4, 0xb, 0x3, 0xf, 0x7 },
	{ 0x1, 0xd, 0x5, 0x9, 0xa, 0x2, 0xe, 0x6, 0x8, 0x0, 0xc, 0x4, 0x3, 0xf, 0x7, 0xb },
	{ 0x1, 0xd, 0x5, 0x9, 0x2, 0xe, 0x6, 0xa, 0x0, 0xc, 0x4, 0x8, 0x3, 0xf, 0x7, 0xb },
	{ 0xd, 0x5, 0x9, 0x1, 0x2, 0xe, 0x6, 0xa, 0x0, 0xc, 0x4, 0x8, 0xf, 0x7, 0xb, 0x3 },
	{ 0xd, 0x5, 0x9, 0x1, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0xf, 0x7, 0xb, 0x3 },
	{ 0x5, 0x9, 0x1, 0xd, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0x7, 0xb, 0x3, 0xf },
	{ 0x5, 0x9, 0x1, 0xd, 0x6, 0xa, 0x2, 0xe, 0x4, 0x8, 0x0, 0xc, 0x7, 0xb, 0x3, 0xf },
	{ 0x9, 0x1, 0xd, 0x5, 0x6, 0xa, 0x2, 0xe, 0x4, 0x8, 0x0, 0xc, 0xb, 0x3, 0xf, 0x7 },

	{ 0xa, 0x2, 0xe, 0x6, 0x8, 0x0, 0xc, 0x4, 0xb, 0x3, 0xf, 0x7, 0x9, 0x1, 0xd, 0x5 },
	{ 0xa, 0x2, 0xe, 0x6, 0x8, 0x0, 0xc, 0x4, 0x3, 0xf, 0x7, 0xb, 0x1, 0xd, 0x5, 0x9 },
	{ 0x2, 0xe, 0x6, 0xa, 0x0, 0xc, 0x4, 0x8, 0x3, 0xf, 0x7, 0xb, 0x1, 0xd, 0x5, 0x9 },
	{ 0x2, 0xe, 0x6, 0xa, 0x0, 0xc, 0x4, 0x8, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1 },
	{ 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1 },
	{ 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0x7, 0xb, 0x3, 0xf, 0x5, 0x9, 0x1, 0xd },
	{ 0x6, 0xa, 0x2, 0xe, 0x4, 0x8, 0x0, 0xc, 0x7, 0xb, 0x3, 0xf, 0x5, 0x9, 0x1, 0xd },
	{ 0x6, 0xa, 0x2, 0xe, 0x4, 0x8, 0x0, 0xc, 0xb, 0x3, 0xf, 0x7, 0x9, 0x1, 0xd, 0x5 },

	{ 0x8, 0x0, 0xc, 0x4, 0xb, 0x3, 0xf, 0x7, 0x9, 0x1, 0xd, 0x5, 0xa, 0x2, 0xe, 0x6 },
	{ 0x8, 0x0, 0xc, 0x4, 0x3, 0xf, 0x7, 0xb, 0x1, 0xd, 0x5, 0x9, 0xa, 0x2, 0xe, 0x6 },
	{ 0x0, 0xc, 0x4, 0x8, 0x3, 0xf, 0x7, 0xb, 0x1, 0xd, 0x5, 0x9, 0x2, 0xe, 0x6, 0xa },
	{ 0x0, 0xc, 0x4, 0x8, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0x2, 0xe, 0x6, 0xa },
	{ 0xc, 0x4, 0x8, 0x0, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0xe, 0x6, 0xa, 0x2 },
	{ 0xc, 0x4, 0x8, 0x0, 0x7, 0xb, 0x3, 0xf, 0x5, 0x9, 0x1, 0xd, 0xe, 0x6, 0xa, 0x2 },
	{ 0x4, 0x8, 0x0, 0xc, 0x7, 0xb, 0x3, 0xf, 0x5, 0x9, 0x1, 0xd, 0x6, 0xa, 0x2, 0xe },
	{ 0x4, 0x8, 0x0, 0xc, 0xb, 0x3, 0xf, 0x7, 0x9, 0x1, 0xd, 0x5, 0x6, 0xa, 0x2, 0xe },

	{ 0xb, 0x3, 0xf, 0x7, 0x9, 0x1, 0xd, 0x5, 0xa, 0x2, 0xe, 0x6, 0x8, 0x0, 0xc, 0x4 },
	{ 0x3, 0xf, 0x7, 0xb, 0x1, 0xd, 0x5, 0x9, 0xa, 0x2, 0xe, 0x6, 0x8, 0x0, 0xc, 0x4 },
	{ 0x3, 0xf, 0x7, 0xb, 0x1, 0xd, 0x5, 0x9, 0x2, 0xe, 0x6, 0xa, 0x0, 0xc, 0x4, 0x8 },
	{ 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0x2, 0xe, 0x6, 0xa, 0x0, 0xc, 0x4, 0x8 },
	{ 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0 },
	{ 0x7, 0xb, 0x3, 0xf, 0x5, 0x9, 0x1, 0xd, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0 },
	{ 0x7, 0xb, 0x3, 0xf, 0x5, 0x9, 0x1, 0xd, 0x6, 0xa, 0x2, 0xe, 0x4, 0x8, 0x0, 0xc },
	{ 0xb, 0x3, 0xf, 0x7, 0x9, 0x1, 0xd, 0x5, 0x6, 0xa, 0x2, 0xe, 0x4, 0x8, 0x0, 0xc },
};

static unsigned char crypt_table6[][16] =
{
	//  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,   A,   B,   C,   D,   E,   F
	{ 0x5, 0x9, 0x1, 0xf, 0x7, 0xb, 0x3, 0xd, 0x4, 0x8, 0x0, 0xe, 0x6, 0xa, 0x2, 0xc },
	{ 0x9, 0x1, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x8, 0x0, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4 },
	{ 0x1, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x0, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8 },
	{ 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1 },

	{ 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0xe, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0xf },
	{ 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0xe, 0x6, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0xf, 0x7 },
	{ 0x2, 0xc, 0x4, 0x8, 0x0, 0xe, 0x6, 0xa, 0x3, 0xd, 0x5, 0x9, 0x1, 0xf, 0x7, 0xb },
	{ 0xc, 0x4, 0x8, 0x0, 0xe, 0x6, 0xa, 0x2, 0xd, 0x5, 0x9, 0x1, 0xf, 0x7, 0xb, 0x3 },

	{ 0x4, 0x8, 0x0, 0xe, 0x6, 0xa, 0x2, 0xc, 0x5, 0x9, 0x1, 0xf, 0x7, 0xb, 0x3, 0xd },
	{ 0x8, 0x0, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x9, 0x1, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5 },
	{ 0x0, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x1, 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9 },
	{ 0xf, 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0xe, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0 },

	{ 0x7, 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0xf, 0x6, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0xe },
	{ 0xb, 0x3, 0xd, 0x5, 0x9, 0x1, 0xf, 0x7, 0xa, 0x2, 0xc, 0x4, 0x8, 0x0, 0xe, 0x6 },
	{ 0x3, 0xd, 0x5, 0x9, 0x1, 0xf, 0x7, 0xb, 0x2, 0xc, 0x4, 0x8, 0x0, 0xe, 0x6, 0xa },
	{ 0xd, 0x5, 0x9, 0x1, 0xf, 0x7, 0xb, 0x3, 0xc, 0x4, 0x8, 0x0, 0xe, 0x6, 0xa, 0x2 },
};

static UINT8 dc1(UINT32 b, int adr)
{
	int t;
	UINT8 db, nb;
	nb = NIBBLE(b, 19,18,9,5);

	t = 0;
	db = crypt_table1[t][nb];
	return db;
}

static UINT8 dc2(UINT32 b, int adr)
{
	int t;
	UINT8 db, nb;
	nb = NIBBLE(b, 17,16,11,10);

	t = 0;
	db = crypt_table2[t][nb];
	return db;
}

/*static UINT8 dc3(UINT32 b, int adr)
{
	int t;
	UINT8 nb = NIBBLE(b, 22,21,20,6);
	UINT8 db;

	t = 0;
	t |= ((adr + 0x450) >> 15) & 0x1;
	if( (adr + 0x450) >= 0x10000 )
		t = 1;

	db = crypt_table3[t][nb];
	return db;
}*/

static UINT8 dc3(UINT32 b, int adr)
{
	int t;
	UINT8 nb = NIBBLE(b, 22,21,9,6);
	UINT8 db;

	t = 0;
	t |= ((adr + 0x450) >> 15) & 0x1;
	if( (adr + 0x450) >= 0x10000 )
		t = 1;

	db = crypt_table3[t][nb];
	return db;
}

static UINT8 dc4(UINT32 b, int adr)
{
	int t;
	UINT8 nb = NIBBLE(b, 15,14,4,23);
	UINT8 db;

	t = 0;
	t |= ((adr + 0x450) >> 12) & 0xf;

	db = crypt_table4[t][nb];
	return db;
}

static UINT8 dc5(UINT32 b, int adr)
{
	int t;
	UINT8 nb = NIBBLE(b, 0,1,7,8);
	UINT8 db;

	t = 0;
	t |= ((adr + 0x50) >> 7) & 0x1f;
	db = crypt_table5[t][nb];

	return db;
}

static UINT8 dc6(UINT32 b, int adr)
{
	int t;
	UINT8 nb = NIBBLE(b, 13,12,3,2);
	UINT8 db;

	t = (adr >> 4) & 0xf;

	db = crypt_table6[t][nb];
	return db;
}

void seibuspi_text_decrypt(unsigned char *rom)
{
	int i;
	for(i=0; i<0x10000; i++) {
		UINT8 r1,r2,r3,r4,r5,r6;
		UINT32 w;

		w = (rom[(i*3) + 0] << 16) | (rom[(i*3) + 1] << 8) | (rom[(i*3) +2]);

		r1 = dc1(w, i);
		r2 = dc2(w, i);
		r3 = dc3(w, i);
		r4 = dc4(w, i);
		r5 = dc5(w, i);
		r6 = dc6(w, i);

		rom[(i*3) + 0] = (r1 << 4) | r2;
		rom[(i*3) + 1] = (r3 << 4) | r4;
		rom[(i*3) + 2] = (r5 << 4) | r6;
	}
}

void seibuspi_bg_decrypt(unsigned char *rom, int size)
{
	int i,j;
	for(j=0; j<size; j+=0xc0000) {
		for(i=0; i<0x40000; i++) {
			UINT8 r1,r2,r3,r4,r5,r6;
			UINT32 w;

			w = (rom[j + (i*3) + 0] << 16) | (rom[j + (i*3) + 1] << 8) | (rom[j + (i*3) + 2]);

			r1 = dc1(w, i/4);
			r2 = dc2(w, i/4);
			r3 = dc3(w, i/4);
			r4 = dc4(w, i/4);
			r5 = dc5(w, i/4);
			r6 = dc6(w, i/4);

			rom[j + (i*3) + 0] = (r1 << 4) | r2;
			rom[j + (i*3) + 1] = (r3 << 4) | r4;
			rom[j + (i*3) + 2] = (r5 << 4) | r6;
		}
	}
}



/* Raiden Fighters 2 */

static UINT32 preprocess_rf2(UINT32 b, int i)
{
	if( i & 0x10 ) {
		b ^= 0x4;
	}
	if( i & 0x20 ) {
		b ^= 0x8;
	}
	if( (i - 0x20) & 0x40 ) {
		b ^= 0x100000;
	}
	if( (i - 0x20) & 0x80 ) {
		b ^= 0x200000;
	}
	if( (i + 0x20) & 0x200 ) {
		b ^= 0x80;
	}
	if( (i + 0x1e0) & 0x400 ) {
		b ^= 0x2;
	}
	if( (i + 0x1e0) & 0x800 ) {
		b ^= 0x1;
	}
	if( (i + 0x1e0) & 0x1000 ) {
		b ^= 0x8000;
	}
	return b;
}

static unsigned char rf2_crypt_table1[][16] =
{
	{ 0x9, 0x1, 0x8, 0x0, 0xb, 0x3, 0xa, 0x2, 0xd, 0x5, 0xc, 0x4, 0xf, 0x7, 0xe, 0x6 }
};

static unsigned char rf2_crypt_table6[][16] =
{
	{ 0x6, 0xe, 0x2, 0xa, 0x4, 0xc, 0x0, 0x8, 0x7, 0xf, 0x3, 0xb, 0x5, 0xd, 0x1, 0x9 }
};

static UINT8 rf2_dc1(UINT32 b, int adr)
{
	int t;
	UINT8 db, nb;
	nb = NIBBLE(b, 17,11,10,5);

	t = 0;
	db = rf2_crypt_table1[t][nb];
	return db;
}

static UINT8 rf2_dc2(UINT32 b, int adr)
{
	return 0xf;
}

static UINT8 rf2_dc3(UINT32 b, int adr)
{
	return 0xf;
}

static UINT8 rf2_dc4(UINT32 b, int adr)
{
	return 0xf;
}

static UINT8 rf2_dc5(UINT32 b, int adr)
{
	return 0xf;
}

static UINT8 rf2_dc6(UINT32 b, int adr)
{
	int t;
	UINT8 db, nb;
	b = preprocess_rf2(b, adr);
	nb = NIBBLE(b, 21,20,3,2);

	t = 0;
	db = rf2_crypt_table6[t][nb];
	return db;
}

void seibuspi_rf2_text_decrypt(unsigned char *rom)
{
	int i;
	for(i=0; i<0x10000; i++) {
		UINT8 r1,r2,r3,r4,r5,r6;
		UINT32 w;

		w = (rom[(i*3) + 0] << 16) | (rom[(i*3) + 1] << 8) | (rom[(i*3) +2]);

		r1 = rf2_dc1(w, i);
		r2 = rf2_dc2(w, i);
		r3 = rf2_dc3(w, i);
		r4 = rf2_dc4(w, i);
		r5 = rf2_dc5(w, i);
		r6 = rf2_dc6(w, i);


		rom[(i*3) + 0] = (r1 << 4) | r2;
		rom[(i*3) + 1] = (r3 << 4) | r4;
		rom[(i*3) + 2] = (r5 << 4) | r6;
	}
}

void seibuspi_rf2_bg_decrypt(unsigned char *rom, int size)
{
	int i,j;
	for(j=0; j<size; j+=0xc0000) {
		for(i=0; i<0x40000; i++) {
			UINT8 r1,r2,r3,r4,r5,r6;
			UINT32 w;

			w = (rom[j + (i*3) + 0] << 16) | (rom[j + (i*3) + 1] << 8) | (rom[j + (i*3) + 2]);

			r1 = rf2_dc1(w, i/4);
			r2 = rf2_dc2(w, i/4);
			r3 = rf2_dc3(w, i/4);
			r4 = rf2_dc4(w, i/4);
			r5 = rf2_dc5(w, i/4);
			r6 = rf2_dc6(w, i/4);

			rom[j + (i*3) + 0] = (r1 << 4) | r2;
			rom[j + (i*3) + 1] = (r3 << 4) | r4;
			rom[j + (i*3) + 2] = (r5 << 4) | r6;
		}
	}
}
